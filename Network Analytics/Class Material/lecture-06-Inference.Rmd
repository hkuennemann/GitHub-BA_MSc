# Session 6: Inference in Networks

### Example

1.  Question:

    *Does participating in central movies lead to more frequent future participation in
    movies?* \pp
    
    *Are actors that participate in movies with higher centrality more
    likely to participate in more movies in the future?*

2.  Steps:

    1.  Get data about actors&rsquo; movie participation and movie centrality
    2.  Prepare the data for regression
    3.  Run regression and interpret results


### Step 1: Get the data

Load the data into R

```{r   }
library(data.table)     # Run once per session
library(igraph)         # Run once per session
library(ggplot2)         # Run once per session

load("imdb_movie_actor.RData")
dt.movie.actor 
```


### Step 2: Prepare the data for regression

```{r   }
# Create bipartite graph and movie projection
all.actors <- dt.movie.actor[, list(name=unique(actor), type=TRUE)]
all.movies <- dt.movie.actor[, list(name=unique(movie), type=FALSE)]
   
all.vertices <- rbind(all.actors, all.movies)
g <- graph.data.frame(dt.movie.actor[, list(movie, actor)], directed=FALSE, vertices=all.vertices)

g.movies <- bipartite.projection(g)$proj1 
```


### Step 2: Prepare the data for regression

```{r   }
# Focus on the actors that have participated in the top 50 movies of 2019
top.movies.2019 <- dt.movie.actor[year == 2019, .N, 
                                  by=list(movie, votes)][order(-votes)][1:50, movie]
actors.in.top.movies.2019 <- dt.movie.actor[movie %in% top.movies.2019, unique(actor)] 
```

```{r   }
# Create a data.table with movie centrality year by year
dt.movies.year <-
  do.call(rbind,
          lapply(2000:2019,
                 function(yr) {
                   # Create a graph with movies of a given 5 year range
                   g.movies.5yrs <-
                     induced.subgraph(g.movies,
                                      V(g.movies)$name %in%
                                      dt.movie.actor[year <= yr & 
                                                     year > (yr - 5) & 
                                                     actor %in% actors.in.top.movies.2019, movie])
                   # Calculate centralities based on 5 year graph
                   V(g.movies.5yrs)$movie_degree      <- degree(g.movies.5yrs)
                   V(g.movies.5yrs)$movie_closeness   <- closeness(g.movies.5yrs)
                   V(g.movies.5yrs)$movie_betweenness <- betweenness(g.movies.5yrs)
                   V(g.movies.5yrs)$movie_evcent      <- evcent(g.movies.5yrs)$vector
                   V(g.movies.5yrs)$movie_clustering  <- transitivity(g.movies.5yrs, type="local")
                   # Keep only the movies of current year
                   g.movies.yr <-
                     induced.subgraph(g.movies.5yrs,
                                      V(g.movies.5yrs)$name %in% dt.movie.actor[year == yr, movie])
                   V(g.movies.yr)$movie_year <- yr
                   # Create a data.table with movie centralies from the graph 
                   data.table(get.data.frame(g.movies.yr, "vertices"))
                 })
          ) 
```


### Step 2: Prepare the data for regression

```{r   }
# Create previous movies and future movies
dt.movie.actor <- dt.movie.actor[order(actor, year)]
dt.movie.actor[, prev_movies := 0:(.N-1), by=list(actor)]
dt.movie.actor[, future_movies := n_movies - prev_movies]

# Merge the individual level data with the network data 
dt.movie.actor.centr <- merge(dt.movie.actor, dt.movies.year,
                              by.x=c('movie', 'year'),
                              by.y=c('name', 'movie_year')) 
```


### Step 2: Prepare the data for regression

```{r   }
tail(dt.movie.actor.centr, 6) 
```


### Step 3: Run the regressions


### Future Movies as a function of Degree

```{r   }
summary(reg.1 <- lm(future_movies ~ movie_degree + prev_movies + factor(year), 
                    data=dt.movie.actor.centr)) 
```


### Future Movies as a function of Betweenness

```{r   }
summary(reg.3 <- lm(future_movies ~ movie_betweenness + prev_movies + factor(year), 
                    data=dt.movie.actor.centr)) 
```


```{r   }
summary(reg.2 <- lm(future_movies ~ movie_closeness + prev_movies + factor(year), 
                    data=dt.movie.actor.centr)) 
```


```{r   }
summary(reg.4 <- lm(future_movies ~ movie_evcent + prev_movies + factor(year), 
                    data=dt.movie.actor.centr)) 
```


```{r   }
summary(reg.5 <- lm(future_movies ~ movie_clustering + prev_movies + factor(year), 
                    data=dt.movie.actor.centr)) 
```


```{r   }
summary(reg.6 <- lm(future_movies ~ movie_degree + movie_closeness + movie_betweenness + movie_evcent + movie_clustering + prev_movies + factor(year), 
                    data=dt.movie.actor.centr)) 
```


### Future Movies as a function of Centrality

```{r   }
library(stargazer)
stargazer(reg.1, reg.2, reg.3,
          reg.4, reg.5, reg.6,
          type="text",
          omit = "factor.year",
          omit.labels = c("Year Dummies"),
          omit.stat = c("f", "ser", "adj.rsq")) 
```



